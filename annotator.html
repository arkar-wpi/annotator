<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>AMT Annotator</title>
    <style>
        canvas {
            border: 1px solid black;
        }

        #container {
            position: relative;
            width: 300px;
            height: 200px;
        }

        #canvas, #tempCanvas {
            position: absolute;
            top: 0;
            left: 0;
        }
    </style>
</head>
<body>
<h1>Draw the direction of the gaze from the anywhere inside the bounding box surrounding the head</h1>

<div>Click on the region inside the head bounding box and drag until the region/object/person/face&nbsp;where the
    subject is looking by dragging the mouse. If the subject is looking out of the frame, draw the gaze direction&nbsp;until
    the edge of the frame. If the subject is looking <b>*inwards*&nbsp;</b>or <strong>*outwards*</strong> of the
    picture, click on the eyes (or) back of the head once and a cross will be drawn instead of a line.
</div>


<p id="button_paragraph">
    <button type="button" id='clear_all'>Clear All</button>
    <button type="button" id='undo'>Undo</button>
    <input id="annotation_data" name="annotation_data" type="hidden"/>
</p>

<div id="container">
    <canvas id="canvas" width="500" height="500" oncontextmenu="return false"></canvas>
    <canvas id="tempCanvas" width="500" height="500" oncontextmenu="return false"></canvas>
</div>

<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
<script>
    function Annotator(options) {
        this.annotations = [];
        this.canvas = document.getElementById('canvas');
        this.tempCanvas = document.getElementById('tempCanvas');
        this.press = 0;
        this.ctx = canvas.getContext('2d');
        this.tempCtx = tempCanvas.getContext('2d');
        this.boxes = options.boxes;
        this.url = options.url;

        this.loadImage();

        this.clearAllButton = document.getElementById("clear_all");
        this.clearAllButton.addEventListener('click', this.clearAll.bind(this));

        this.undoButton = document.getElementById("undo");
        this.undoButton.addEventListener('click', this.undo.bind(this));

        this.tempCanvas.addEventListener('mousedown', this.canvasMouseDown.bind(this));
        this.tempCanvas.addEventListener('mouseup', this.canvasMouseUp.bind(this));
        this.tempCanvas.addEventListener('mousemove', this.canvasMouseMove.bind(this));
        this.tempCanvas.addEventListener('mouseenter', this.canvasMouseEnter.bind(this));
        this.tempCanvas.addEventListener('mouseout', this.canvasMouseOut.bind(this));
        this.onchange = options.onchange

    }

    Annotator.prototype.drawBoxes = function () {
//        console.log(this.boxes.length);
        for (var i = 0; i < this.boxes.length; i++) {
            let b = this.boxes[i];
            this.ctx.strokeStyle = 'orange';
            this.ctx.lineWidth = 1;
            this.ctx.rect(b['x'],b['y'],b['w'],b['h']);
            this.ctx.stroke();
        }
    };

    Annotator.prototype.drawLine = function (context, toX, toY) {
        context.strokeStyle = 'red';
        context.beginPath();
        context.moveTo(this.startX, this.startY);
        context.lineTo(this.endX, this.endY);
        context.lineWidth = 2;
        context.stroke();
        context.beginPath();
        context.arc(this.endX, this.endY, 5, 0, 2 * Math.PI, false);
        context.fillStyle = 'red';
        context.fill();
        context.stroke();
    };

    Annotator.prototype.drawCross = function (toX, toY) {
        let x = toX;
        let y = toY;
        this.ctx.strokeStyle = 'aqua';
        this.ctx.beginPath();

        this.ctx.moveTo(x - 10, y - 10);
        this.ctx.lineTo(x + 10, y + 10);
        this.ctx.lineWidth = 2;
        this.ctx.stroke();

        this.ctx.moveTo(x + 10, y - 10);
        this.ctx.lineTo(x - 10, y + 10);
        this.ctx.lineWidth = 2;
        this.ctx.stroke();

    };

    Annotator.prototype.transferLine = function (toX, toY) {
        let distance = Math.sqrt(Math.pow(this.startX - toX, 2) + Math.pow(this.startY - toY, 2))
//        console.log(distance);
        if (distance < 3) {
            this.drawCross(toX, toY);
        } else {
            this.endX = toX;
            this.endY = toY;
            this.drawLine(this.ctx, toX, toY);
        }
    };


    Annotator.prototype.canvasMouseEnter = function (e) {
        this.tempCanvas.style.cursor = 'crosshair';
    };

    Annotator.prototype.canvasMouseUp = function (e) {
        let pos = this.getCoords(e);
        this.press = 0;

        this.endX = pos['x'];
        this.endY = pos['y'];
        this.refreshLines();
        this.transferLine(this.endX, this.endY);
        this.annotations.push({x1: this.startX, y1: this.startY, x2: this.endX, y2: this.endY});
//        console.log(this.annotations);
        return this.onchange(this.annotations);
    };

    Annotator.prototype.canvasMouseDown = function (e) {
        let pos = this.getCoords(e);
        this.press = 1;
        this.startX = pos['x'];
        this.startY = pos['y'];
    };

    Annotator.prototype.canvasMouseMove = function (e) {
        if (this.press === 1) {
            let pos = this.getCoords(e);
            this.endX = pos['x'];
            this.endY = pos['y'];

            this.refreshLines();
            this.drawLine(this.tempCtx, this.endX, this.endY);
        }
    };

    Annotator.prototype.canvasMouseOut = function (e) {
        if (this.press === 1) {
            let pos = this.getCoords(e);
            this.press = 0;

            this.endX = pos['x'];
            this.endY = pos['y'];
            this.refreshLines();
            this.transferLine(this.endX, this.endY);
            this.annotations.push({x1: this.startX, y1: this.startY, x2: this.endX, y2: this.endY});
//            console.log(this.annotations);
            this.press = 0;
            return this.onchange(this.annotations);
        }
    };

    Annotator.prototype.loadImage = function () {
        this.img = new Image();
        this.img.src = this.url;
        this.img.onload = function () {
            this.canvas.width = this.img.width;
            this.canvas.height = this.img.height;
            this.tempCanvas.width = this.img.width;
            this.tempCanvas.height = this.img.height;
            this.ctx.drawImage(this.img, 0, 0, this.img.width, this.img.height, 0, 0, this.canvas.width, this.canvas.height);
            this.drawBoxes();

            for (var i = 0; i < this.annotations.length; i++) {
                var l = this.annotations[i];
                this.startX = l['x1'];
                this.startY = l['y1'];
                this.transferLine(l['x2'], l['y2']);
            }
        }.bind(this);
    };

    Annotator.prototype.refreshLines = function () {
        this.tempCtx.clearRect(0, 0, this.tempCanvas.width, this.canvas.height);
    };

//    Annotator.prototype.refreshImage = function () {
//        this.ctx.drawImage(this.img, 0, 0, this.img.width, this.img.height, 0, 0, this.canvas.width, this.canvas.height);
//        this.drawBoxes();
//    };

    Annotator.prototype.undo = function () {
        let last_point = this.annotations.pop();
        this.ctx.clearRect(0, 0, this.canvas.width, this.canvas.height);
        this.loadImage();

        return this.onchange(this.annotations);
    };

    Annotator.prototype.clearAll = function () {
        this.annotations = [];
        this.ctx.clearRect(0, 0, this.canvas.width, this.canvas.height);
//        this.refreshLines();
//        this.refreshImage();
        this.loadImage();
        return this.onchange(this.annotations);
    };

    Annotator.prototype.getCoords = function (e) {
        let r = canvas.getBoundingClientRect();
        return {x: e.clientX - r.left, y: e.clientY - r.top}
    };

    $(document).ready(function () {
//        debugger;
        new Annotator({
//            url: "${image_URL}",
//            boxes: ${bounding_box},
            boxes: [{'y': 194, 'x': 246, 'h': 60, 'w': 60}, {'y': 224, 'x': 51, 'h': 52, 'w': 52},
                {'y': 100, 'x': 273, 'h': 57, 'w': 57}, {'y': 188, 'x': 250, 'h': 69, 'w': 69}],
            url: "https://s3.amazonaws.com/wpi-gaze/00005047.jpg",
            onchange: function (entries) {
                console.log(entries);
                $("#annotation_data").val(JSON.stringify(entries));

                if (entries.length > 0 &&
                    assignment_id !== "" &&
                    assignment_id !== "ASSIGNMENT_ID_NOT_AVAILABLE") {
                    $("#submitButton").removeAttr("disabled");
                } else {
                    $("#submitButton").attr("disabled", "disabled");
                }
            }
        });

//        var assignment_id = turkGetParam('assignmentId', "");
        var assignment_id = "";
        // Disable the submission at the beginning.
        $('#submitButton').attr("disabled", "disabled");
        $("#submitButton").detach().appendTo("#button_paragraph");
        if (assignment_id === "ASSIGNMENT_ID_NOT_AVAILABLE") {
            $("#submitButton").val("This is preview");
        }
//        console.log(assignment_id);
    });
</script>
</body>
</html>
