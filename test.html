<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>AMT Annotator</title>
    <style>
        canvas {
            border: 1px solid black;
        }
    </style>
</head>
<body>
<!--<input type='file' name='img' size='65' id='uploadimage'/>-->
<button type="button" id='clear_all'>Clear All</button>

<div id="container">

    <canvas id="canvas" width="500" height="500"></canvas>
    <canvas id="tempCanvas" width="500" height="500"></canvas>
</div>


<style>
   #container {
        position:relative;
        width:300px;
        height:200px;
    }
    #canvas, #tempCanvas {
        position: absolute;
        top: 0px;
        left: 0px;
    }
</style>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js">
    function Annotator() {
        this.annotations = [];
        this.canvas = document.getElementById('canvas');
        this.tempCanvas = document.getElementById('tempCanvas');
//        var canvasOffset = this.canvas.offset();
//        this.offsetX = canvasOffset.left;
//        this.offsetY = canvasOffset.top;
        this.press = 0
        this.ctx = canvas.getContext('2d');
        this.tempCtx = tempCanvas.getContext('2d');
        this.loadImage();
//        this.uploadImageButton = document.getElementById("uploadimage");
        this.clearAllButton = document.getElementById("clear_all");
//        this.uploadImageButton.addEventListener('change', this.drawImage.bind(this));
        this.clearAllButton.addEventListener('click', this.clearAll.bind(this));
        this.tempCanvas.addEventListener('mousedown', this.canvasMouseDown.bind(this));
        this.tempCanvas.addEventListener('mouseup', this.canvasMouseUp.bind(this));
        this.tempCanvas.addEventListener('mousemove', this.canvasMouseMove.bind(this));
        this.tempCanvas.addEventListener('mouseenter', this.canvasMouseEnter.bind(this));
//
    }

    Annotator.prototype.drawLine = function(toX, toY){
        this.tempCtx.strokeStyle = 'red';
        this.tempCtx.beginPath();
        this.tempCtx.moveTo(this.startX, this.startY);
        this.tempCtx.lineTo(this.endX, this.endY);
        this.tempCtx.lineWidth = 2;
        this.tempCtx.stroke();
    }

    Annotator.prototype.transferLine = function(toX, toY){
        this.ctx.strokeStyle = 'red';
        this.ctx.beginPath();
        this.ctx.moveTo(this.startX, this.startY);
        this.ctx.lineTo(this.endX, this.endY);
        this.ctx.lineWidth = 2;
        this.ctx.stroke();
    }


    Annotator.prototype.canvasMouseEnter = function (e) {
        this.tempCanvas.style.cursor = 'crosshair';
    };

    Annotator.prototype.canvasMouseUp = function (e) {
        let pos = this.getCoords(e);
        this.press = 0

        this.endX = pos['x'];
        this.endY = pos['y'];
        this.transferLine(this.endX, this.endY);
        this.annotations.push({x1: this.startX, y1: this.startY, x2:this.endX, y2:this.endY});
        console.log(this.annotations);
    };

    Annotator.prototype.canvasMouseDown = function (e) {
        let pos = this.getCoords(e);
        this.press = 1;
        this.startX = pos['x'];
        this.startY = pos['y'];
    };

    Annotator.prototype.canvasMouseMove = function (e) {
        if (this.press == 1) {
            let pos = this.getCoords(e);
            this.endX = pos['x'];
            this.endY = pos['y'];
            this.refreshLines();
//            this.refreshImage();
            this.drawLine(this.endX, this.endY);
//            this.ctx.strokeStyle = 'red';
//            this.drawLine(this.endX, this.endY);
        }
    }

    Annotator.prototype.loadImage = function () {
        this.img = new Image();
        this.img.src = "https://s3.amazonaws.com/wpi-gaze/00005010.jpg";
        this.img.onload = function () {
            this.canvas.width = this.img.width;
            this.canvas.height = this.img.height;
            this.tempCanvas.width = this.img.width;
            this.tempCanvas.height = this.img.height;
            this.ctx.drawImage(this.img, 0, 0, this.img.width, this.img.height, 0, 0, this.canvas.width, this.canvas.height);
//            url.revokeObjectURL(src);
        }.bind(this);
    };

    Annotator.prototype.refreshLines = function() {
        this.tempCtx.clearRect(0, 0, this.tempCanvas.width, this.canvas.height);
    }

    Annotator.prototype.refreshImage = function() {
        this.ctx.drawImage(this.img, 0, 0, this.img.width, this.img.height, 0, 0, this.canvas.width, this.canvas.height);
    }

//    Annotator.prototype.drawImage = function () {
//        this.img = new Image();
//        let f = this.uploadImageButton.files[0],
//            url = window.URL || window.webkitURL;
//        const src = url.createObjectURL(f);
////        this.img.src = src;
//        this.img.src = "https://s3.amazonaws.com/wpi-gaze/00005010.jpg";
//        this.img.onload = function () {
//            this.canvas.width = this.img.width
//            this.canvas.height = this.img.height
//            this.ctx.drawImage(this.img, 0, 0, this.img.width, this.img.height, 0, 0, this.canvas.width, this.canvas.height);
//            url.revokeObjectURL(src);
//
//        }.bind(this);
//    };

    Annotator.prototype.clearAll = function () {
//        this.ctx.clearRect(0, 0, this.canvas.width, this.canvas.height);
        this.annotations = [];
        this.refreshLines();
        this.refreshImage();
    };

    Annotator.prototype.getCoords = function (e) {
        let r = canvas.getBoundingClientRect();
        return {x: e.clientX - r.left, y: e.clientY - r.top}
    };

    window.onload = function () {
        window.annotator = new Annotator();
    };

    //Get this working
//    $(document).ready(function() {
        var annotator = new Annotator();
//        var assignment_id = turkGetParam('assignmentId', "");
//        // Initialize the bounding-box annotator.
//        var annotator = new BBoxAnnotator({
//            url: "https://s3.amazonaws.com/wpi-gaze/00005000.jpg",
//            input_method: 'select', // Can be one of ['text', 'select', 'fixed']
//            labels: ["in", "out", "object"], // Label of the object.
//            onchange: function(entries) {
//                $("#annotation_data").val(JSON.stringify(entries));
//                if (entries.length > 0 &&
//                    assignment_id != "" &&
//                    assignment_id != "ASSIGNMENT_ID_NOT_AVAILABLE") {
//                    $("#submitButton").removeAttr("disabled");
//                }
//                else {
//                    $("#submitButton").attr("disabled", "disabled");
//                }
//            }
//        });
//        // Initialize the reset button.
//        $("#reset_button").click(function(e) {
//            annotator.clear_all();
//        });
//        // Disable the submission at the beginning.
//        $("#submitButton").attr("disabled", "disabled");
//        $("#submitButton").detach().appendTo("#button_paragraph");
//        if (assignment_id == "ASSIGNMENT_ID_NOT_AVAILABLE") {
//            $("#submitButton").val("This is preview");
//        }
//        console.log(assignment_id);
//    });
</script>
</body>
</html>
