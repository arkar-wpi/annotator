<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>AMT Annotator</title>
    <style>
        canvas {
            border: 1px solid black;
        }
    </style>
</head>
<body>
<link href="https://ajax.googleapis.com/ajax/libs/jqueryui/1.10.3/themes/smoothness/jquery-ui.css" rel="stylesheet" />
<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
<script src="https://ajax.googleapis.com/ajax/libs/jqueryui/1.10.3/jquery-ui.js"></script>
<p id="button_paragraph">
    <button type="button" id='clear_all'>Clear All</button>
    <input id="annotation_data" name="annotation_data" type="hidden" />
</p>

<div id="container">
    <canvas id="canvas" width="500" height="500"></canvas>
    <canvas id="tempCanvas" width="500" height="500"></canvas>
</div>


<style>

   #container {
        position:relative;
        width:300px;
        height:200px;
    }
    #canvas, #tempCanvas {
        position: absolute;
        top: 0px;
        left: 0px;
    }
</style>
<script>
    function Annotator(options) {
        this.annotations = [];
        this.canvas = document.getElementById('canvas');
        this.tempCanvas = document.getElementById('tempCanvas');
//        var canvasOffset = this.canvas.offset();
//        this.offsetX = canvasOffset.left;
//        this.offsetY = canvasOffset.top;
        this.press = 0;
        this.ctx = canvas.getContext('2d');
        this.tempCtx = tempCanvas.getContext('2d');
        this.loadImage(options.url);
        this.clearAllButton = document.getElementById("clear_all");
        this.clearAllButton.addEventListener('click', this.clearAll.bind(this));
        this.tempCanvas.addEventListener('mousedown', this.canvasMouseDown.bind(this));
        this.tempCanvas.addEventListener('mouseup', this.canvasMouseUp.bind(this));
        this.tempCanvas.addEventListener('mousemove', this.canvasMouseMove.bind(this));
        this.tempCanvas.addEventListener('mouseenter', this.canvasMouseEnter.bind(this));
        this.onchange = options.onchange

    }

    Annotator.prototype.drawLine = function(toX, toY){
        this.tempCtx.strokeStyle = 'red';
        this.tempCtx.beginPath();
        this.tempCtx.moveTo(this.startX, this.startY);
        this.tempCtx.lineTo(this.endX, this.endY);
        this.tempCtx.lineWidth = 2;
        this.tempCtx.stroke();
    }

    Annotator.prototype.transferLine = function(toX, toY){
        this.ctx.strokeStyle = 'red';
        this.ctx.beginPath();
        this.ctx.moveTo(this.startX, this.startY);
        this.ctx.lineTo(this.endX, this.endY);
        this.ctx.lineWidth = 2;
        this.ctx.stroke();
    }


    Annotator.prototype.canvasMouseEnter = function (e) {
        this.tempCanvas.style.cursor = 'crosshair';
    };

    Annotator.prototype.canvasMouseUp = function (e) {
        let pos = this.getCoords(e);
        this.press = 0

        this.endX = pos['x'];
        this.endY = pos['y'];
        this.transferLine(this.endX, this.endY);
        this.annotations.push({x1: this.startX, y1: this.startY, x2:this.endX, y2:this.endY});
        console.log(this.annotations);
        return this.onchange(this.annotations);
    };

    Annotator.prototype.canvasMouseDown = function (e) {
        let pos = this.getCoords(e);
        this.press = 1;
        this.startX = pos['x'];
        this.startY = pos['y'];
    };

    Annotator.prototype.canvasMouseMove = function (e) {
        if (this.press == 1) {
            let pos = this.getCoords(e);
            this.endX = pos['x'];
            this.endY = pos['y'];
            this.refreshLines();
//            this.refreshImage();
            this.drawLine(this.endX, this.endY);
//            this.ctx.strokeStyle = 'red';
//            this.drawLine(this.endX, this.endY);
        }
    }

    Annotator.prototype.loadImage = function (src_url) {
        this.img = new Image();
        this.img.src = src_url;
//        this.img.src = "https://s3.amazonaws.com/wpi-gaze/00005010.jpg";
        this.img.onload = function () {
            this.canvas.width = this.img.width;
            this.canvas.height = this.img.height;
            this.tempCanvas.width = this.img.width;
            this.tempCanvas.height = this.img.height;
            this.ctx.drawImage(this.img, 0, 0, this.img.width, this.img.height, 0, 0, this.canvas.width, this.canvas.height);
//            url.revokeObjectURL(src);
        }.bind(this);
    };

    Annotator.prototype.refreshLines = function() {
        this.tempCtx.clearRect(0, 0, this.tempCanvas.width, this.canvas.height);
    }

    Annotator.prototype.refreshImage = function() {
        this.ctx.drawImage(this.img, 0, 0, this.img.width, this.img.height, 0, 0, this.canvas.width, this.canvas.height);
    }

//    Annotator.prototype.drawImage = function () {
//        this.img = new Image();
//        let f = this.uploadImageButton.files[0],
//            url = window.URL || window.webkitURL;
//        const src = url.createObjectURL(f);
////        this.img.src = src;
//        this.img.src = "https://s3.amazonaws.com/wpi-gaze/00005010.jpg";
//        this.img.onload = function () {
//            this.canvas.width = this.img.width
//            this.canvas.height = this.img.height
//            this.ctx.drawImage(this.img, 0, 0, this.img.width, this.img.height, 0, 0, this.canvas.width, this.canvas.height);
//            url.revokeObjectURL(src);
//
//        }.bind(this);
//    };

    Annotator.prototype.clearAll = function () {
//        this.ctx.clearRect(0, 0, this.canvas.width, this.canvas.height);
        this.annotations = [];
        this.refreshLines();
        this.refreshImage();
        return this.onchange(this.annotations);
    };

    Annotator.prototype.getCoords = function (e) {
        let r = canvas.getBoundingClientRect();
        return {x: e.clientX - r.left, y: e.clientY - r.top}
    };

//    window.onload = function () {
//        window.annotator = new Annotator();
//    };

    //Get this working
    $(document).ready(function() {
        var annotator = new Annotator({
            url: "https://s3.amazonaws.com/wpi-gaze/00005010.jpg",
            onchange: function(entries) {
                $("#annotation_data").val(JSON.stringify(entries));

                if (entries.length > 0 &&
                    assignment_id != "" &&
                    assignment_id != "ASSIGNMENT_ID_NOT_AVAILABLE") {
                    $("#submitButton").removeAttr("disabled");
                }
                else {
                    $("#submitButton").attr("disabled", "disabled");
                }
            }
        });

//        var assignment_id = turkGetParam('assignmentId', "");
        var assignment_id = "";
        // Disable the submission at the beginning.
        $("#submitButton").attr("disabled", "disabled");
        $("#submitButton").detach().appendTo("#button_paragraph");
        if (assignment_id == "ASSIGNMENT_ID_NOT_AVAILABLE") {
            $("#submitButton").val("This is preview");
        }
        console.log(assignment_id);
    });
</script>
</body>
</html>
